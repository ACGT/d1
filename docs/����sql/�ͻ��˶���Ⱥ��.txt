select * into d1marketing..sms110518_2 from (
select DISTINCT odrmst_rphone,max(odrmst_mbrid) mbrid from  odrmst_recent,odrdtl_recent 
where odrmst_odrid=odrdtl_odrid --and len(odrmst_rphone)=11 
--and (odrmst_rphone like '13%' or odrmst_rphone like '15%' or odrmst_rphone like '18%') 
and odrmst_mbrid not in(select mbrmstpingan_mbrid from mbrmstpingan) 
and odrmst_orderdate>='2010-6-1' and odrmst_orderdate<='2011-5-15' --and (odrdtl_rackcode like '014%') 
and odrdtl_gdsname like '%±´¼ÑË¹%'
--and odrdtl_gdsid='01409782'
 and (odrdtl_gifttype='' or odrdtl_gifttype is null) 
and odrdtl_finalprice>1 and odrdtl_shipstatus=3 and odrmst_orderstatus in (3,31,5,51,6,61) 
and odrmst_rphone not in(select phone from badsms) 
and odrmst_mbrid not in (202828)
group by odrmst_rphone )a


select odrmst_rphone,case when  len(mbrmst_uid)>10 then left(mbrmst_uid,10)+'**' else rtrim(mbrmst_uid) end  from d1marketing..sms110518_2  join mbrmst on mbrid=mbrmst_id
where len(odrmst_rphone)=11 
and (odrmst_rphone like '13%' or odrmst_rphone like '15%' or odrmst_rphone like '18%') 

insert into d1marketing..sms110518_2 
select DISTINCT odrmst_rphone,max(odrmst_mbrid) 
from  dba.odrmst_history,dba.odrdtl_history
where odrmst_odrid=odrdtl_odrid and len(odrmst_rphone)=11 
and (odrmst_rphone like '13%' or odrmst_rphone like '15%' or odrmst_rphone like '18%') 
and odrmst_mbrid not in(select mbrmstpingan_mbrid from mbrmstpingan) 
and odrmst_orderdate>='2010-6-1' and odrmst_orderdate<='2011-5-15' --and (odrdtl_rackcode like '014%') 
and odrdtl_gdsname like '%±´¼ÑË¹%' and (odrdtl_gifttype='' or odrdtl_gifttype is null) 
and odrdtl_finalprice>1 and odrdtl_shipstatus=3 and odrmst_orderstatus in (3,31,5,51,6,61) 
and odrmst_rphone not in(select phone from badsms) 
and odrmst_mbrid not in (202828)
and odrmst_rphone not in (select odrmst_rphone from d1marketing..sms110518_2 ) --!!!!!!!!!!!!!!!!!!!!!1
group by odrmst_rphone 