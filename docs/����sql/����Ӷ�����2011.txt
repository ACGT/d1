
sp_who_lock
         百货类 服装、饰品类     F&M 
领可特     5%    10%              20% 
成果       5%    10%              20% 
亿起发     5%    10%              20% 
51返利     4%    化妆品8%               12% 
悠易       9%    18%              18% 

declare @starttime datetime 
declare @endtime datetime 
set @starttime='2011-4-1'
set @endtime='2011-5-1'
---化妆品\服装、饰品类 
update 
 olmodr set 佣金比例=0.08 
where 订单日期>=@starttime and 订单日期<@endtime
 and (分类号  like '015009%' or 分类号 like '017%' or 分类号 like '014%')  and 联盟='51fanli'

--百货类
update 
 olmodr set 佣金比例=0.04
where 1=1
and 订单日期>=@starttime and 订单日期<@endtime and (分类号 not like '015009%' and 分类号 not like '017%' and 分类号 not like '014%') and 联盟='51fanli'

-- F&M 
update olmodr set 佣金比例=0.12 from olmodr  join gdsmst on 商品编号=gdsmst_gdsid

where 订单日期>=@starttime and 订单日期<@endtime
and 联盟='51fanli' and gdsmst_brand='001346'




declare @starttime datetime 
declare @endtime datetime 
set @starttime='2011-4-1'
set @endtime='2011-5-1'
--优易015009、017 佣金比例0.18其它0.09
--更新0.18的佣金比例
update 
 olmodr set 佣金比例=0.18 
where 订单日期>=@starttime and 订单日期<@endtime
 and (分类号  like '015009%' or 分类号 like '017%')  and 联盟='yoyi'

--更新0.09的佣金比例
update 
 olmodr set 佣金比例=0.09
where 1=1
and 订单日期>=@starttime and 订单日期<@endtime and (分类号 not like '015009%' and 分类号 not like '017%') and 联盟='yoyi'


--更新0.40亿起发导航的佣金比例
update 
 olmodr set 佣金比例=0.40 
where 订单日期>=@starttime and 订单日期<@endtime and 联盟='4599yiqifa'






--eqifa chanet linktech 联盟FM 20%返点
 --服装和饰品10%  其它5%



declare @starttime datetime 
declare @endtime datetime 
set @starttime='2011-4-1'
set @endtime='2011-5-1'
update 
 olmodr set 佣金比例=0.10
where 1=1
and 订单日期>=@starttime and 订单日期<@endtime and (分类号  like '015009%' or 分类号 like '017%') 
and (联盟='eqifa' or 联盟='linktech' or 联盟='chanet') 

--更新0.06的佣金比例
update 
 olmodr set 佣金比例=0.05 
where 1=1
and 订单日期>=@starttime and 订单日期<@endtime and (分类号 not like '015009%' and 分类号 not like '017%') 
and (联盟='eqifa' or 联盟='linktech' or 联盟='chanet')  

update olmodr set 佣金比例=0.20 from olmodr  join gdsmst on 商品编号=gdsmst_gdsid

where 订单日期>=@starttime and 订单日期<@endtime
and (联盟='eqifa' or 联盟='linktech' or 联盟='chanet')    and gdsmst_brand='001346'



--更新计算佣金金额
update 
 olmodr
set 佣金金额= round((商品总价*佣金比例),2)

where 1=1
and 订单日期>='2011-4-1' and 订单日期<'2011-5-1'  



--计算用券比例

insert into olmodrdis(odrmst_tktvalue,summnoey,OdrMst_odrid)
select   odrmst_tktvalue,((select isnull(sum(odrdtl_finalprice*odrdtl_gdscount),0)  
from odrdtl_recent where 
odrdtl_gdsname not like '%优惠特价%' and odrdtl_temp<>'团购商品' and (odrdtl_specialflag& 1)<>1 and odrdtl_gdsid<>'01204969'
 and odrdtl_odrid=OdrMst_odrid))summnoey,OdrMst_odrid
--select top 10 * 
from odrmst_recent join olmodr on odrmst_odrid=订单号 where 是否用券='是'
and 订单日期>'2011-4-1' and 订单日期<'2011-5-1'

update olmodrdis set discount=(summnoey-odrmst_tktvalue)/summnoey where summnoey>0 and createdate>'2011-5-20'

 
select top 50 * from olmodrdis where createdate>'2011-5-20' and  discount<0
  and odrmst_odrid='110402005773'



--更新减去用券的佣金
select  佣金金额*isnull(discount,0),佣金金额,isnull(discount,0), 订单号
from  olmodr join (select distinct * from olmodrdis1103 where isnull(discount,0)>0) a on 订单号=odrmst_odrid
where 1=1 and 商品编号<>'01204969'
and 订单日期>='2011-3-1' and 订单日期<'2011-4-1' 

update olmodr set 佣金金额=佣金金额*isnull(discount,0)

from  olmodr join (select distinct * from olmodrdis where isnull(discount,0)>0) a on 订单号=odrmst_odrid
where 1=1 and 商品编号<>'01204969' and  discount<1 and discount>0 
and 订单日期>='2011-4-1' and 订单日期<'2011-5-1' 





